<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        .demo-section {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        .output {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .toast.show {
            opacity: 1;
        }
        .toast.info {
            background: #2196f3;
        }
        .toast.success {
            background: #4caf50;
        }
        .toast.error {
            background: #f44336;
        }
        .toast.warning {
            background: #ff9800;
        }
    </style>
</head>
<body>
    <h1>üß© Module Integration Demo</h1>

    <div class="demo-section">
        <h2>State Manager Demo</h2>
        <button onclick="testStateManager()">Test State Manager</button>
        <div id="state-output" class="output">Click button to test...</div>
    </div>

    <div class="demo-section">
        <h2>DOM Cache Demo</h2>
        <button onclick="testDOMCache()">Test DOM Cache</button>
        <div id="cache-output" class="output">Click button to test...</div>
    </div>

    <div class="demo-section">
        <h2>Formatter Demo</h2>
        <button onclick="testFormatters()">Test Formatters</button>
        <div id="formatter-output" class="output">Click button to test...</div>
    </div>

    <div class="demo-section">
        <h2>Toast Demo</h2>
        <button onclick="showToastDemo('info')">Info Toast</button>
        <button onclick="showToastDemo('success')">Success Toast</button>
        <button onclick="showToastDemo('error')">Error Toast</button>
        <button onclick="showToastDemo('warning')">Warning Toast</button>
    </div>

    <div class="demo-section">
        <h2>Event Bus Demo</h2>
        <button onclick="testEventBus()">Test Event Bus</button>
        <div id="event-output" class="output">Click button to test...</div>
    </div>

    <div class="demo-section">
        <h2>Markdown Demo</h2>
        <button onclick="testMarkdown()">Test Markdown</button>
        <div id="markdown-output" class="output">Click button to test...</div>
    </div>

    <!-- Toast element -->
    <div id="toast" class="toast"></div>

    <script type="module">
        import { appState } from './core/state-manager.js';
        import { domCache } from './utils/dom-cache.js';
        import {
            formatEntityName,
            escapeHtml,
            formatDate,
            formatNumber,
            truncate,
            capitalize
        } from './utils/formatter.js';
        import { Toast } from './components/toast.js';
        import { renderMarkdown } from './utils/markdown.js';
        import { eventBus } from './core/event-bus.js';

        // Make functions available globally for button onclick
        window.testStateManager = function() {
            const output = [];

            // Test 1: Set and get
            appState.set('network.data', { nodes: 100, edges: 200 });
            const data = appState.get('network.data');
            output.push(`‚úÖ Set/Get: ${JSON.stringify(data)}`);

            // Test 2: Nested access
            appState.set('entities.bios', { 'John Doe': 'Test bio' });
            const bio = appState.get('entities.bios')['John Doe'];
            output.push(`‚úÖ Nested: ${bio}`);

            // Test 3: Subscribe
            let subscribeResult = 'pending...';
            appState.subscribe('network.selectedNode', (node) => {
                subscribeResult = `Node selected: ${node}`;
                output.push(`‚úÖ Subscribe: ${subscribeResult}`);
                document.getElementById('state-output').textContent = output.join('\n');
            });
            appState.set('network.selectedNode', 'test-node-123');

            setTimeout(() => {
                document.getElementById('state-output').textContent = output.join('\n');
            }, 100);
        };

        window.testDOMCache = function() {
            const output = [];

            // Clear cache for accurate stats
            domCache.clear();

            // Test 1: Cache element
            const element = domCache.get('cache-output');
            output.push(`‚úÖ Cached element: ${element ? element.tagName : 'null'}`);

            // Test 2: Cache hit
            const element2 = domCache.get('cache-output');
            output.push(`‚úÖ Cache hit: ${element === element2}`);

            // Test 3: Stats
            const stats = domCache.getStats();
            output.push(`‚úÖ Stats: ${JSON.stringify(stats, null, 2)}`);

            document.getElementById('cache-output').textContent = output.join('\n');
        };

        window.testFormatters = function() {
            const output = [];

            // Test formatters
            output.push(`formatEntityName: ${formatEntityName('Epstein, Jeffrey')}`);
            output.push(`escapeHtml: ${escapeHtml('<script>alert("xss")</script>')}`);
            output.push(`formatNumber: ${formatNumber(1234567)}`);
            output.push(`truncate: ${truncate('A'.repeat(150), 50)}`);
            output.push(`capitalize: ${capitalize('hello world from epstein')}`);
            output.push(`formatDate: ${formatDate(new Date(), 'short')}`);

            document.getElementById('formatter-output').textContent = output.join('\n');
        };

        window.showToastDemo = function(type) {
            const messages = {
                info: 'This is an info message',
                success: 'Operation completed successfully!',
                error: 'An error occurred!',
                warning: 'Warning: Please be careful'
            };
            Toast.show(messages[type], type);
        };

        window.testEventBus = function() {
            const output = [];

            // Test 1: Basic event
            eventBus.on('test-event', (data) => {
                output.push(`‚úÖ Event received: ${JSON.stringify(data)}`);
                document.getElementById('event-output').textContent = output.join('\n');
            });
            eventBus.emit('test-event', { message: 'Hello from event bus!' });

            // Test 2: Once
            let onceCount = 0;
            eventBus.once('once-event', () => {
                onceCount++;
            });
            eventBus.emit('once-event');
            eventBus.emit('once-event'); // Should not trigger
            output.push(`‚úÖ Once event count: ${onceCount} (should be 1)`);

            // Test 3: Unsubscribe
            let unsubCount = 0;
            const unsub = eventBus.on('unsub-event', () => {
                unsubCount++;
            });
            eventBus.emit('unsub-event');
            unsub(); // Unsubscribe
            eventBus.emit('unsub-event'); // Should not trigger
            output.push(`‚úÖ Unsub count: ${unsubCount} (should be 1)`);

            setTimeout(() => {
                document.getElementById('event-output').textContent = output.join('\n');
            }, 100);
        };

        window.testMarkdown = async function() {
            const output = [];

            try {
                const markdown = `
# Test Heading

This is a **bold** text and this is *italic*.

- List item 1
- List item 2
- List item 3

[Link](https://example.com)
                `.trim();

                const html = await renderMarkdown(markdown);
                output.push('‚úÖ Markdown rendered successfully:\n\n' + html);
            } catch (error) {
                output.push('‚ùå Error: ' + error.message);
            }

            document.getElementById('markdown-output').innerHTML = output.join('\n');
        };

        // Initialize
        console.log('‚úÖ All modules loaded successfully');
        console.log('State Manager:', appState);
        console.log('DOM Cache:', domCache);
        console.log('Event Bus:', eventBus);
    </script>
</body>
</html>
