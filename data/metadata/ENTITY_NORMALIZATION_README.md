# Entity Name Normalization System

**Last Updated**: 2025-11-17
**Status**: ✅ Implemented and Verified

## Problem Solved

Flight logs contained OCR artifacts with name variations that created duplicate entities:
- **"Je Epstein"** appeared with 5 different whitespace variations
- **"Ghislaine Ghislaine"** (duplicated first name pattern)
- **"Bill Clinton"** vs. canonical "William Clinton"
- **"Nadia Nadia"** instead of "Nadia Marcinkova"

This caused:
- Inflated entity counts (387 instead of 296)
- Split connection counts across duplicate nodes
- Inaccurate relationship strengths (228 flights vs. 478 actual)

## Solution Overview

Comprehensive entity name normalization system with three components:

### 1. Entity Name Mappings (`entity_name_mappings.json`)
- **265 name mappings** covering 241 unique canonical entities
- Generated by: `scripts/utils/build_entity_mappings.py`
- Handles:
  - Whitespace normalization (multiple spaces → single space)
  - Duplicated name patterns ("Je Je Epstein" → "Jeffrey Epstein")
  - Known aliases and abbreviations
  - Title/prefix removal where appropriate

**Top Entities by Variant Count**:
```
Jeffrey Epstein: 6 variants
  - Je Epstein, J Epstein, JE, Jeff Epstein
  - Je        Je Epstein (5 whitespace variations)

William Clinton: 5 variants
  - Bill Clinton, Bill Bill Clinton
  - President Clinton, WJC

Ghislaine Maxwell: 4 variants
  - Ghislaine, Ghislaine Ghislaine
  - GM, G Maxwell

Nadia Marcinkova: 2 variants
  - Nadia Nadia

Virginia Giuffre: 3 variants
  - Virginia Roberts, Virginia Virginia Roberts
```

### 2. Normalization Utility (`scripts/utils/entity_normalization.py`)

**EntityNormalizer Class**:
```python
from entity_normalization import normalize_name

# Normalize single name
canonical = normalize_name("Je        Je Epstein")
# Returns: "Jeffrey Epstein"

# Normalize list of names
names = normalize_names(["Je Epstein", "Ghislaine Ghislaine"])
# Returns: ["Jeffrey Epstein", "Ghislaine Maxwell"]

# Get all variants of canonical name
normalizer = EntityNormalizer()
variants = normalizer.get_all_variants("Jeffrey Epstein")
# Returns: {"Jeffrey Epstein", "Je Epstein", "JE", "J Epstein", ...}
```

**Features**:
- Whitespace normalization (multiple spaces → single space)
- Direct mapping lookup (O(1) performance)
- Fallback to whitespace-normalized form if no mapping exists
- Statistics tracking (total mappings, unique canonical names)

### 3. Server Disambiguation Service (`server/services/entity_disambiguation.py`)

**Updated to load mappings from JSON** (instead of hardcoded aliases):
```python
from services.entity_disambiguation import get_disambiguator

disambiguator = get_disambiguator()

# Normalize name
canonical = disambiguator.normalize_name("Je Epstein")
# Returns: "Jeffrey Epstein"

# Search entity with disambiguation
entity = disambiguator.search_entity("Je Epstein", entity_stats)
# Automatically finds "Jeffrey Epstein" if direct match fails

# Merge duplicate nodes in network
deduplicated_nodes = disambiguator.merge_duplicate_nodes(nodes)
# Consolidates "Je Epstein" variants into "Jeffrey Epstein"
```

## Impact Metrics

### Before Normalization
- **Total Entities**: 387 network nodes
- **Total Connections**: 2,221 edges
- **Top Relationship**: Je Epstein ↔ Ghislaine (228 flights)
- **Jeffrey Epstein Nodes**: 5 separate nodes with different whitespace
- **Ghislaine Maxwell Nodes**: 2 nodes ("Ghislaine Ghislaine" + "Ghislaine Maxwell")

### After Normalization
- **Total Entities**: 296 network nodes (-91 duplicates, **23% reduction**)
- **Total Connections**: 1,818 edges (correctly consolidated)
- **Top Relationship**: Jeffrey Epstein ↔ Ghislaine Maxwell (478 flights, **+109% accurate count**)
- **Jeffrey Epstein**: 1 node with 274 connections (was split across 5)
- **Ghislaine Maxwell**: 1 node with 198 connections

### Duplicates Eliminated
- **91 duplicate nodes removed**
- **403 edges consolidated** (2,221 → 1,818)
- **Connection counts corrected** (previously split across variants)

## Files Modified

### New Files Created
1. **`data/metadata/entity_name_mappings.json`**
   - 265 name mappings (variant → canonical)
   - Generated by `build_entity_mappings.py`

2. **`scripts/utils/build_entity_mappings.py`**
   - Analyzes entity index to detect duplicates
   - Generates normalization mappings
   - Includes manual mappings for known entities

3. **`scripts/utils/entity_normalization.py`**
   - EntityNormalizer class for name normalization
   - Utility functions: `normalize_name()`, `normalize_names()`
   - Statistics and variant tracking

4. **`data/metadata/ENTITY_NORMALIZATION_README.md`** (this file)
   - Documentation of normalization system

### Files Updated
1. **`scripts/analysis/rebuild_flight_network.py`**
   - Imports EntityNormalizer
   - Normalizes passenger names during flight parsing
   - Merges entity data when building network nodes
   - **Result**: Network now has 296 nodes (down from 387)

2. **`server/services/entity_disambiguation.py`**
   - Loads mappings from JSON file (instead of hardcoded)
   - Dynamic loading on initialization
   - Fallback to empty mappings if file not found

3. **`data/metadata/entity_network.json`** (rebuilt)
   - 296 nodes (91 duplicates removed)
   - 1,818 edges (consolidated)
   - Correct connection counts per entity

## Verification Tests

All tests passing ✅:

### 1. Normalization Tests
```
✓ "Je        Je Epstein" -> "Jeffrey Epstein"
✓ "Je         Je Epstein" -> "Jeffrey Epstein"
✓ "Ghislaine Ghislaine" -> "Ghislaine Maxwell"
✓ "Bill Clinton" -> "William Clinton"
✓ "Nadia Nadia" -> "Nadia Marcinkova"
✓ "Unknown Person" -> "Unknown Person" (unchanged)
```

### 2. Network Presence Tests
```
✓ Jeffrey Epstein: 274 connections
✓ Ghislaine Maxwell: 198 connections
✓ William Clinton: 28 connections
✓ Nadia Marcinkova: 49 connections
✗ Je Epstein: Not found (correctly removed)
✗ Ghislaine Ghislaine: Not found (correctly removed)
```

### 3. Server Disambiguation Tests
```
✓ Loaded 265 entity name mappings
✓ Query "Je Epstein" found "Jeffrey Epstein"
✓ Query "Ghislaine Ghislaine" found "Ghislaine Maxwell"
✓ Query "Bill Clinton" found "William Clinton"
```

## Rebuilding After Changes

If entity mappings need to be updated:

```bash
# 1. Rebuild mappings from entity index
python3 scripts/utils/build_entity_mappings.py

# 2. Rebuild flight network with new mappings
python3 scripts/analysis/rebuild_flight_network.py

# 3. Restart server to reload mappings
# (or reload disambiguator service)
```

## Design Decisions

### Why JSON File Instead of Hardcoded Aliases?

**Rationale**:
- **Single Source of Truth**: All mappings in one place
- **Maintainability**: Update mappings without code changes
- **Auditability**: Easy to review all name variations
- **Consistency**: Flight network and server use same mappings

**Trade-offs**:
- Performance: One-time file load (~265 mappings, negligible)
- Complexity: Requires mappings file to exist (graceful fallback)

### Why Normalize During Network Build?

**Rationale**:
- **Accuracy**: Consolidates duplicates at source
- **Performance**: Normalization once during build, not at query time
- **Correctness**: Connection counts accurately reflect reality

**Alternative Considered**: Normalize at query time (rejected due to complexity)

### Fallback Strategy

If `entity_name_mappings.json` not found:
1. Log warning message
2. Use empty mappings (whitespace normalization only)
3. Don't fail initialization (graceful degradation)

## Known Limitations

1. **Manual Mapping Required**: New name variations must be added manually
   - Solution: Run `build_entity_mappings.py` periodically to detect new duplicates

2. **Ambiguous Names**: Some names may be legitimately different people
   - Example: "Andrew" could be Prince Andrew or another Andrew
   - Mitigation: Use explicit alias dictionary, not fuzzy matching

3. **Historical Data**: Old classifications may still reference variant names
   - Solution: Rebuild semantic index after normalization updates

## Future Enhancements

1. **Automatic Duplicate Detection**:
   - Use fuzzy matching (Levenshtein distance) to suggest new mappings
   - Flag entities with >80% name similarity for review

2. **Name Disambiguation UI**:
   - Admin interface to review and approve mappings
   - Track mapping confidence scores

3. **Version History**:
   - Track mapping changes over time
   - Allow rollback if incorrect merge detected

4. **Cross-Source Validation**:
   - Check if same person appears in multiple sources
   - Use external data (Wikipedia, news articles) to validate

## References

- **Entity Index**: `data/md/entities/ENTITIES_INDEX.json`
- **Flight Logs**: `data/md/entities/flight_logs.md`
- **Network Analysis**: `data/metadata/entity_network_stats.txt`
- **Mappings**: `data/metadata/entity_name_mappings.json`

---

**Status**: System operational and verified ✅
**Impact**: 91 duplicates eliminated, 23% reduction in entity count
**Accuracy**: Connection counts now reflect true co-occurrence frequencies
